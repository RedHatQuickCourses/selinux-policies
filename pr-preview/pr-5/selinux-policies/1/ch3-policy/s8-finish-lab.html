<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: Finish a Custom SELinux Policy Module for a Confined Domain :: Writing Targeted Policies for SELinux on RHEL</title>
    <link rel="prev" href="s7-redistribute.html">
    <link rel="next" href="s9-summary.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Writing Targeted Policies for SELinux on RHEL</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/selinux-policies/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="selinux-policies" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Writing Targeted Policies for SELinux on RHEL</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch1-need/index.html">Review of SELinux</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s1-intro.html">Why You Should Care About SELinux?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s2-setup-lab.html">Lab: Verify the Status of SELinux in a RHEL Machine</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s3-labels.html">SELinux Policies, Labels, and Contexts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s4-labels-lab.html">Lab: Explore Labels and Policy Rules in a RHEL Machine</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s5-rhel.html">How Red Hat Protects System Services on RHEL With SELinux</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s6-confined-lab.html">Lab: Explore Confined and Unconfined Processes in RHEL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s7-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch2-configure/index.html">SELinux Management</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-configure/s1-support.html">Supporting SELinux</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-configure/s2-webapp-lab.html">Lab: Configure SELinux for a Web Application</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-configure/s3-avc.html">Interpreting AVC messages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-configure/s4-troubleshoot-lab.html">Lab: Troubleshoot SELinux policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-configure/s5-multihost.html">Consistent SELinux settings</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-configure/s6-ansible-lab.html">Lab: Automate SELinux Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-configure/s7-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Extending SELinux Policies</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s1-generate.html">Create a Custom SELinux Policy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s2-generic-lab.html">Lab: Create a Generic SELinux Policy Module</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s3-interfaces.html">Reference SELinux Interfaces</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s4-files-lab.html">Lab: Reference Interfaces From a Custom SELinux Policy Module</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s5-manual-vs-auto.html">Manual or Automatic Policy Creation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s6-network-lab.html">Lab: Allow Network Access to a Confined Domain</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s7-redistribute.html">Package SELinux Policy Modules</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="s8-finish-lab.html">Lab: Finish a Custom SELinux Policy Module for a Confined Domain</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s9-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Writing Targeted Policies for SELinux on RHEL</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Writing Targeted Policies for SELinux on RHEL</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Writing Targeted Policies for SELinux on RHEL</a></li>
    <li><a href="index.html">Extending SELinux Policies</a></li>
    <li><a href="s8-finish-lab.html">Lab: Finish a Custom SELinux Policy Module for a Confined Domain</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lab: Finish a Custom SELinux Policy Module for a Confined Domain</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Estimated reading time: <strong>7 minutes</strong>.</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Objective</dt>
<dd>
<p>Resolve the latest AVC errors from a custom policy module and ensure that it works in enforcing mode.</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
All activities in this chapter require the results of the previous activities. You are not required to perform all of them at once, but it&#8217;s certainly easier. If you must pause between activities, ensure you can continue using the same RHEL machine.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_before_you_begin"><a class="anchor" href="#_before_you_begin"></a>Before you Begin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You need a RHEL machine to which you have either root password or unrestricted sudo, and also access to Red Hat Enterprise Linux package repositories, to install any missing packages. That machine must be configured with:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SELinux enabled and enforced, using the targeted policy.</p>
</li>
<li>
<p>The <code>setools-console</code> package.</p>
</li>
<li>
<p>The <code>policycoreutils-python-utils</code> package.</p>
</li>
<li>
<p>The <code>selinux-policy-devel</code> package.</p>
</li>
<li>
<p>The <code>rpm-build</code> package.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These instructions were tested on RHEL 9.3 but should work with minimal change on older releases (since RHEL 7) and newer releases.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instructions"><a class="anchor" href="#_instructions"></a>Instructions</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>This activity is a continuation of the <a href="s6-network-lab.html" class="xref page">previous activity</a>. It requires that the third-party application be already installed as a system service, with a custom policy which runs the application in a permissive domain and allows network connections to remote HTTP servers and access to system files.</p>
<div class="paragraph">
<p>1.1. Check that the test application service is still active. It will terminate when it&#8217;s done retrieving the weather from all cities, and in that case you need to restart it. Remember to record the timestamp so you can filter audit events.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>systemctl is-active testapp</strong>
inactive
$ <strong>TIME=$(date +%T) ; sudo systemctl restart testapp</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>1.2. Find the PID of the test application service and check that it&#8217;s running in a permissive domain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>systemctl show --property MainPID --value testapp</strong>
39521
$ <strong>ps -Z 39521</strong>
LABEL                               PID TTY      STAT   TIME COMMAND
system_u:system_r:testapp_t:s0    39521 ?        S      0:00 /usr/local/sbin/testapp -d
$ <strong>sudo semanage permissive -l | grep -c testapp_t</strong>
1</code></pre>
</div>
</div>
<div class="paragraph">
<p>1.3. If you need, enter the directory with the custom policy module from the previous activity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>cd selinux-testapp</strong>
$ <strong>ls</strong>
noarch  testapp.fc  testapp.if  testapp.pp  testapp.sh  testapp.te  testapp_selinux-1.0-1.el9.src.rpm  testapp_selinux.8  testapp_selinux.spec  tmp</code></pre>
</div>
</div>
</li>
<li>
<p>Review what should be the latest AVC error from the third-party application.</p>
<div class="paragraph">
<p>2.1. The AVC error relates to another system configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo ausearch -m AVC -x /usr/local/sbin/testapp --start $TIME --just-one</strong>
----
time-&gt;Thu Jul 25 20:01:13 2024
type=PROCTITLE msg=audit(1721937673.666:665): proctitle=2F7573722F6C6F63616C2F7362696E2F74657374617070002D64
type=SYSCALL msg=audit(1721937673.666:665): arch=c000003e syscall=262 success=yes exit=0 a0=ffffff9c a1=7f9e947bbab9 a2=7f9e93cda340 a3=0 items=0 ppid=1 pid=6537 auid=4294967295 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=(none) ses=4294967295 comm="testapp" exe="/usr/local/sbin/testapp" subj=system_u:system_r:testapp_t:s0 key=(null)
type=AVC msg=audit(1721937673.666:665): avc:  denied  { getattr } for  pid=6537 comm="testapp" path="/etc/resolv.conf" dev="vda4" ino=67109244 scontext=system_u:system_r:testapp_t:s0 tcontext=system_u:object_r:net_conf_t:s0 tclass=file permissive=1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Did you know that, in Linux, it&#8217;s not the operating system, but it&#8217;s user applications, that perform DNS searches? All those details are hidden from developers by library code.</p>
</div>
<div class="paragraph">
<p>2.2. Find an interface that matches the AVC error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo ausearch -m AVC -x /usr/local/sbin/testapp --start $TIME --just-one | audit2allow -R</strong>
...
#============= testapp_t ==============
sysnet_read_config(testapp_t)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that you should review the comments on the source of this interface and also expand it to review all allow statements it generates. In the interest of time, let&#8217;s move on, knowing this is the expected interface for network clients that perform DNS queries.</p>
</div>
<div class="paragraph">
<p>2.3. Add the interface to the end of the <code>testapp.te</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
logging_send_syslog_msg(testapp_t)

miscfiles_read_localization(testapp_t)

# Before this line, all rules were auto-generated

kernel_read_system_state(testapp_t)

miscfiles_read_certs(testapp_t)
miscfiles_search_generic_cert_dirs(testapp_t)

allow testapp_t self:tcp_socket { connect create getattr getopt setopt };
allow testapp_t self:udp_socket { connect create getattr setopt };
corenet_tcp_connect_http_port(testapp_t)

# Before this line, all rules come from the previous activities

sysnet_read_config(testapp_t)</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the updated policy module fixes all remaining AVC errors from the third-party application.</p>
<div class="paragraph">
<p>3.1. Build and reload the policy module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo ./testapp.sh</strong>
Building and Loading Policy
+ make -f /usr/share/selinux/devel/Makefile testapp.pp
Compiling targeted testapp module
Creating targeted testapp.pp policy package
...
+ exit 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>3.3. Restart the test application, recording a timer so you can filter AVC errors from before and after the operation, and check that there are no more AVC errors related to UDP and TCP sockets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>TIME=$(date +%T) ; sudo systemctl restart testapp</strong>
$ <strong>sudo ausearch -m AVC -x /usr/local/sbin/testapp --start $TIME | grep -c resolv.conf</strong>
&lt;no matches&gt;
0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the string "no matches" in the previous output. It means that the <code>ausearch</code> command found no audit events matching the search criteria. There was nothing for the <code>grep</code> command to search in.</p>
</div>
</li>
<li>
<p>Remove the permissive flag and perform a final check for no remaining AVCs.</p>
<div class="paragraph">
<p>4.1. Delete the following line from the <code>testapp.te</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">permissive testapp_t;</code></pre>
</div>
</div>
<div class="paragraph">
<p>4.2. Build and reload the policy module one last time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo ./testapp.sh</strong>
Building and Loading Policy
+ make -f /usr/share/selinux/devel/Makefile testapp.pp
Compiling targeted testapp module
Creating targeted testapp.pp policy package
...
+ exit 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>4.3. Restart the test application, recording a timer so you can filter AVC errors from before and after the operation, and check that there are no more AVC errors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>TIME=$(date +%T) ; sudo systemctl restart testapp</strong>
$ <strong>sudo ausearch -m AVC -x /usr/local/sbin/testapp --start $TIME</strong>
&lt;no matches&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>4.4. Ensure the test application service is not running in a permissive domain anymore:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo semanage permissive -l | grep -c testapp_t</strong>
0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Good work! Now the third-party applications runs fully confined by SELinux.</p>
</div>
</li>
<li>
<p>Review the generated RPM package containing the policy module, for redistribution to other machines running the third-party application.</p>
<div class="paragraph">
<p>5.1. The autogenerated script <code>testapp.sh</code> already includes commands to build RPM packages and source RPM packages. We are interested in the RPM package:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ls noarch</strong>
testapp_selinux-1.0-1.el9.noarch.rpm</code></pre>
</div>
</div>
<div class="paragraph">
<p>5.2. Review the contents of the generated RPM package:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>rpm -ql -p noarch/testapp_selinux-1.0-1.el9.noarch.rpm</strong>
/usr/share/man/man8/testapp_selinux.8.gz
/usr/share/selinux/devel/include/contrib/testapp.if
/usr/share/selinux/packages/testapp.pp</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that it includes the binary policy module, its interface definition file (in case it provides reusable interfaces for other modules), and an autogenerated manual page which is not very useful as-is but could be if you add comments to your interface file.</p>
</div>
<div class="paragraph">
<p>5.3. Review the scriptlets of the generated RPM package:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>rpm -q --scripts -p noarch/testapp_selinux-1.0-1.el9.noarch.rpm</strong>
postinstall scriptlet (using /bin/sh):
semodule -n -i /usr/share/selinux/packages/testapp.pp
if /usr/sbin/selinuxenabled ; then
    /usr/sbin/load_policy

restorecon -R /usr/local/sbin/testapp;
restorecon -R /var/run/testapp.pid;

fi;
exit 0
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The postuninstall scriplet was omitted from the previous output, but it just reverses the effects of the postinstall scriptlet: it unloads the binary policy module and relabels all files affected by it.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_next_steps"><a class="anchor" href="#_next_steps"></a>Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is the final activity of this course. For a real-world application you would require more iterations, as you exercise different features of the application and review the AVCs errors it generates, but you would still follow this same process and grow your policy module incrementally.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="s7-redistribute.html">Package SELinux Policy Modules</a></span>
  <span class="next"><a href="s9-summary.html">Summary</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
