<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: Create a Generic SELinux Policy Module :: Writing Targeted Policies for SELinux on RHEL</title>
    <link rel="prev" href="s1-generate.html">
    <link rel="next" href="s3-interfaces.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Writing Targeted Policies for SELinux on RHEL</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/selinux-policies/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="selinux-policies" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Writing Targeted Policies for SELinux on RHEL</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch1-need/index.html">Review of SELinux</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s1-intro.html">Why You Should Care About SELinux?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s2-setup-lab.html">Lab: Verify the Status of SELinux in a RHEL Machine</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s3-labels.html">SELinux Policies, Labels, and Contexts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s4-labels-lab.html">Lab: Explore Labels and Policy Rules in a RHEL Machine</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s5-rhel.html">How Red Hat Protects System Services on RHEL With SELinux</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s6-confined-lab.html">Lab: Explore Confined and Unconfined Processes in RHEL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s7-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch2-configure/index.html">SELinux Management</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-configure/s1-support.html">Supporting SELinux</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-configure/s2-webapp-lab.html">Lab: Configure SELinux for a Web Application</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-configure/s3-avc.html">Interpreting AVC messages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-configure/s4-troubleshoot-lab.html">Lab: Troubleshoot SELinux policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-configure/s5-multihost.html">Consistent SELinux settings</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-configure/s6-ansible-lab.html">Lab: Automate SELinux Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-configure/s7-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Extending SELinux Policies</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s1-generate.html">Create a Custom SELinux Policy</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="s2-generic-lab.html">Lab: Create a Generic SELinux Policy Module</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s3-interfaces.html">Reference SELinux Interfaces</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s4-files-lab.html">Lab: Reference Interfaces From a Custom SELinux Policy Module</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s5-manual-vs-auto.html">Manual or Automatic Policy Creation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s6-network-lab.html">Lab: Allow Network Access to a Confined Domain</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s7-redistribute.html">Package SELinux Policy Modules</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s8-finish-lab.html">Lab: Finish a Custom SELinux Policy Module for a Confined Domain</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s9-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Writing Targeted Policies for SELinux on RHEL</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Writing Targeted Policies for SELinux on RHEL</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Writing Targeted Policies for SELinux on RHEL</a></li>
    <li><a href="index.html">Extending SELinux Policies</a></li>
    <li><a href="s2-generic-lab.html">Lab: Create a Generic SELinux Policy Module</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lab: Create a Generic SELinux Policy Module</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Estimated reading time: <strong>6 minutes</strong>.</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Objective</dt>
<dd>
<p>Generate a policy module that runs a compiled application as a permissive domain in confined mode.</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Pending Review
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
All activities in this chapter require the results of the previous activities. You are not required to perform all of them at once, but it&#8217;s certainly easier. If you must pause between activities, ensure you can continue using the same RHEL machine.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_before_you_begin"><a class="anchor" href="#_before_you_begin"></a>Before you Begin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You need a RHEL machine to which you have either the root password or unrestricted sudo, and also access to Red Hat Enterprise Linux package repositories, to install any missing packages. That machine must also be configured with:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SELinux enabled and enforcing, using the targeted policy.</p>
</li>
<li>
<p>The <code>setools-console</code> package.</p>
</li>
<li>
<p>The <code>policycoreutils-python-utils</code> package.</p>
</li>
<li>
<p>The <code>policycoreutils-devel</code> package.</p>
</li>
<li>
<p>The <code>git</code> client.</p>
</li>
<li>
<p>The <code>gcc-c++</code>, <code>make</code>, and <code>libcurl-devel</code> packages.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These instructions were tested on RHEL 9.3 but should work with minimal change on older releases (since RHEL 7) and newer releases.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instructions"><a class="anchor" href="#_instructions"></a>Instructions</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install the sample third-party application, if you didn&#8217;t do it already in a <a href="../ch1-need/s6-confined-lab.html" class="xref page">previous activity</a>.</p>
<div class="paragraph">
<p>1.1. Clone the course samples repository and enter the <code>testapp</code> directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>git clone https://github.com/RedHatQuickCourses/selinux-policies-samples.git</strong>
...
Resolving deltas: 100% (25/25), done.
$ <strong>cd selinux-policies-samples/testapp</strong>
$ <strong>ls</strong>
Makefile  testapp.c  testapp.service</code></pre>
</div>
</div>
<div class="paragraph">
<p>1.2. Compile and install the test application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>make</strong>
g++ -std=c++11 -g -o testapp testapp.c -lcurl
$ <strong>sudo make install</strong>
install -m 0755 testapp /usr/local/sbin
install -m 0644 testapp.service /usr/lib/systemd/system/</code></pre>
</div>
</div>
<div class="paragraph">
<p>1.3. Return to your home directory and start the test application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>cd</strong>
$ <strong>sudo systemctl start testapp</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Ensure the third-party application is unconfined.</p>
<div class="paragraph">
<p>2.1. Check that the test application service is still active. It will terminate when it&#8217;s done retrieving the weather from all cities, and in that case you need to restart it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>systemctl is-active testapp</strong>
active</code></pre>
</div>
</div>
<div class="paragraph">
<p>2.2. Find the PID of the test application service and check its running with the unconfined domain type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>systemctl show --property MainPID --value testapp</strong>
37507
$ <strong>ps -Z 37507</strong>
LABEL                               PID TTY      STAT   TIME COMMAND
system_u:system_r:unconfined_service_t:s0 37507 ? S     0:00 /usr/local/sbin/testapp -d</code></pre>
</div>
</div>
</li>
<li>
<p>Generate a generic policy module that runs the third-party application confined in a domain but in permissive mode.</p>
<div class="paragraph">
<p>3.1. Install the SELinux policy and RPM package development tools.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>dnf install -y selinux-policy-devel rpm-build</strong>
...
Complete!</code></pre>
</div>
</div>
<div class="paragraph">
<p>3.2. Create a new directory for the policy and generate a starter policy from the test application application executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>mkdir selinux-testapp</strong>
$ <strong>cd selinux-testapp</strong>
$ <strong>sepolicy generate --init /usr/local/sbin/testapp</strong>
Created the following files:
/home/student/selinux-testapp/testapp.te # Type Enforcement file
/home/student/selinux-testapp/testapp.if # Interface file
/home/student/selinux-testapp/testapp.fc # File Contexts file
/home/student/selinux-testapp/testapp_selinux.spec # Spec file
/home/student/selinux-testapp/testapp.sh # Setup Script</code></pre>
</div>
</div>
<div class="paragraph">
<p>3.3. Compile and load the starter policy using the generated script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo ./testapp.sh</strong>
Building and Loading Policy
+ make -f /usr/share/selinux/devel/Makefile testapp.pp
Compiling targeted testapp module
Creating targeted testapp.pp policy package
rm tmp/testapp.mod tmp/testapp.mod.fc
+ /usr/sbin/semodule -i testapp.pp
+ sepolicy manpage -p . -d testapp_t
./testapp_selinux.8
+ /sbin/restorecon -F -R -v /usr/local/sbin/testapp
+ /sbin/restorecon -F -R -v /var/run/testapp.pid
...
+ rpmbuild --define '_sourcedir /home/student/selinux-testapp'
...
Wrote: /home/student/selinux-testapp/testapp_selinux-1.0-1.el9.src.rpm
+ exit 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the script already relabels files as required by the policy rules, especially the test application executable and its PID file.</p>
</div>
<div class="paragraph">
<p>3.4. Check that the script generated new files, especially a binary policy module with extension <code>.pp</code> and an RPM package:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ls</strong>
noarch  testapp.fc  testapp.if  testapp.pp  testapp.sh  testapp.te  testapp_selinux-1.0-1.el9.src.rpm  testapp_selinux.8  testapp_selinux.spec  tmp
$ <strong>ls noarch</strong>
testapp_selinux-1.0-1.el9.noarch.rpm</code></pre>
</div>
</div>
</li>
<li>
<p>Restart the third-party application and verify it now runs in a permissive domain:</p>
<div class="paragraph">
<p>4.1. Restart the test application service to ensure its process runs in the new confined domain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo systemctl restart testapp</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>4.2. Find the PID of the test application service and check its new domain type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>systemctl show --property MainPID --value testapp</strong>
7966
$ <strong>ps -Z 7966</strong>
LABEL                               PID TTY      STAT   TIME COMMAND
system_u:system_r:testapp_t:s0     7966 ?        S      0:00 /usr/local/sbin/testapp -d</code></pre>
</div>
</div>
<div class="paragraph">
<p>4.3. Confirm that the new domain type is a permissive domain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo semanage permissive -l</strong>

Builtin Permissive Types

mptcpd_t
testapp_t
rshim_t
...</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the loaded policy now contains policies from the custom policy module:</p>
<div class="paragraph">
<p>5.1. Check that there&#8217;s a domain transition rule from Systemd to the new confined domain type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sesearch -T -s init_t -t testapp_exec_t</strong>
type_transition init_t testapp_exec_t:process testapp_t;
$ <strong>sesearch --allow -s init_t -t testapp_t -c process -p transition</strong>
allow initrc_domain daemon:process transition;</code></pre>
</div>
</div>
<div class="paragraph">
<p>5.2. Check that the new domain type inherits many allow rules from its default attributes, such as access to temporary files, and that the policy also includes some custom allow rules for a new resource type and for its PID file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sesearch --allow -s testapp_t -c file</strong>
...
allow domain tmpfile:file { append getattr ioctl lock read };
allow domain usermodehelper_t:file { getattr ioctl lock open read };
allow domain usr_t:file map;
allow testapp_t testapp_exec_t:file { entrypoint execute getattr ioctl lock map open read };
allow testapp_t testapp_t:file { append getattr ioctl lock open read write };
allow testapp_t testapp_var_run_t:file { append create getattr ioctl link lock open read rename setattr unlink watch watch_reads write };</code></pre>
</div>
</div>
<div class="paragraph">
<p>5.3. Check that, despite all of these allow rules, the test application still generates many AVC errors. Do not try to interpret those errors right now.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo ausearch -m AVC -x /usr/local/sbin/testapp</strong>
...</code></pre>
</div>
</div>
</li>
<li>
<p>Take your time to review the generated policy source files: <code>testapp.if</code>, <code>testapp.fc</code>, and <code>testapp.te</code>. Do you see anything in them which you didn&#8217;t expect?</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_next_steps"><a class="anchor" href="#_next_steps"></a>Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The next activity starts the process of reviewing AVC errors from the third-party application and adding policy rules to fix these AVC errors, by focusing on access to system files.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="s1-generate.html">Create a Custom SELinux Policy</a></span>
  <span class="next"><a href="s3-interfaces.html">Reference SELinux Interfaces</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
