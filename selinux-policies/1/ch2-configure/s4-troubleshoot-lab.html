<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: Troubleshoot SELinux policies :: Writing Targeted Policies for SELinux on RHEL</title>
    <link rel="prev" href="s3-avc.html">
    <link rel="next" href="s5-multihost.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Writing Targeted Policies for SELinux on RHEL</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/selinux-policies/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="selinux-policies" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Writing Targeted Policies for SELinux on RHEL</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch1-need/index.html">Review of SELinux</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s1-intro.html">Why You Should Care About SELinux</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch1-need/s2-intro-quiz.html">Quiz: Do you need a custom SELinux policy?</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../ch1-need/s2-intro-quiz-answers.html">Answers to the Quiz</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s3-setup-lab.html">Lab: Verify the Status of SELinux in a RHEL Machine</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s4-labels.html">SELinux Policies, Labels, and Contexts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s5-labels-lab.html">Lab: Explore Labels and Policy Rules in a RHEL Machine</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s6-rhel.html">How Red Hat Protects System Services With SELinux on RHEL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s7-confined-lab.html">Lab: Explore Confined and Unconfined Processes in RHEL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-need/s8-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">SELinux Management</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s1-support.html">Supporting SELinux</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s2-webapp-lab.html">Lab: Configure SElinux for a Web Application</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s3-avc.html">Interpreting AVC messages</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="s4-troubleshoot-lab.html">Lab: Troubleshoot SELinux policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s5-multihost.html">Consistent SElinux settings</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s6-ansible-lab.html">Lab: Automate SELinux Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s7-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch3-policy/index.html">Extending SELinux Policies</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-policy/s1-generate.html">Create a Custom SELinux Policy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-policy/s2-generic-lab.html">Lab: Create a Generic SELinux Policy Module</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-policy/s4-pid-file-lab.html">Lab: Reference Interfaces From a Custom SELinux Policy Module</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Writing Targeted Policies for SELinux on RHEL</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Writing Targeted Policies for SELinux on RHEL</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Writing Targeted Policies for SELinux on RHEL</a></li>
    <li><a href="index.html">SELinux Management</a></li>
    <li><a href="s4-troubleshoot-lab.html">Lab: Troubleshoot SELinux policies</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lab: Troubleshoot SELinux policies</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Estimated reading time: <strong>5 minutes</strong>.</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Objective</dt>
<dd>
<p>Run an Apache Web Server with changes to its default configuration under the targeted policy set from RHEL.</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Pending Review
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_before_you_begin"><a class="anchor" href="#_before_you_begin"></a>Before you Begin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You need a RHEL machine to which you have the root password or unrestricted sudo and access to Red Hat Enterprise Linux package repositories, to install any missing packages. That machine must also be configured with:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SELinux enabled and enforcing, using the targeted policy.</p>
</li>
<li>
<p>The <code>setools-console</code> package.</p>
</li>
<li>
<p>The <code>policycoreutils-python-utils</code> package.</p>
</li>
<li>
<p>The <code>httpd</code> package.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These instructions were tested on RHEL 9.3 but should work with minimal change on older releases (since RHEL 7) and newer releases.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instructions"><a class="anchor" href="#_instructions"></a>Instructions</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Change the configuration of your Apache Web Server to listen to a non-standard TCP port and serve web pages from a different document root.</p>
<div class="paragraph">
<p>1.1. Verify that the Apache Web Server is installed but not running. It is OK if you have a different version of the <code>httpd</code> package:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>rpm -q httpd</strong>
httpd-2.4.57-5.el9.x86_64
$ <strong>systemctl is-active httpd</strong>
inactive</code></pre>
</div>
</div>
<div class="paragraph">
<p>1.2. Save a backup copy of the configuration file, just in case:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ cp /etc/httpd/conf/httpd.conf $HOME/httpd.conf.sav</code></pre>
</div>
</div>
<div class="paragraph">
<p>1.3. Edit the <code>/etc/httpd/conf/httpd.conf</code> file and change the following three lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
Listen 30000
...
DocumentRoot "/var/website"
...
# Further relax access to the default document root:
&lt;Directory "/var/website"&gt;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can find a copy of the file with all changes already done in the <a href="https://github.com/RedHatQuickCourses/selinux-policies-samples/blob/main/website/httpd.conf">sample app</a> repository.</p>
</div>
<div class="paragraph">
<p>1.4. Create a test web site:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo mkdir /var/website</strong>
$ <strong>sudo echo "&lt;h1&gt;Minimal Web Site&lt;/h1&gt;" &gt; /var/website/index.html</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>1.5. Make the HTML files public, so the web server (and everything else) can access them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo chmod a+rx /var/website/</strong>
$ <strong>sudo chmod a+r /var/website/index.html</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Start the Apache Web Server, verify that it fails to serve web pages, and search for AVC error messages.</p>
<div class="paragraph">
<p>2.1. Try to start the Apache Web Server, it is expected to fail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo systemctl start httpd</strong>
Job for httpd.service failed because the control process exited with error code.
See "systemctl status httpd.service" and "journalctl -xeu httpd.service" for details.</code></pre>
</div>
</div>
<div class="paragraph">
<p>2.2. The web server status shows that it could not listen to the configured port. This shouldn&#8217;t be an issue because the <code>httpd</code> process starts as root.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>systemctl status httpd.service</strong>
...
Jul 19 14:27:36 servera.lab.example.com systemd[1]: Starting The Apache HTTP Server...
Jul 19 14:27:36 servera.lab.example.com httpd[1582]: (13)Permission denied: AH00072: make_sock: could not bind to address [::]:30000
Jul 19 14:27:36 servera.lab.example.com httpd[1582]: (13)Permission denied: AH00072: make_sock: could not bind to address 0.0.0.0:30000
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>2.3. Search for recent AVC errors.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo ausearch -m AVC -ts recent</strong>
----
time-&gt;Fri Jul 19 14:27:36 2024
type=PROCTITLE msg=audit(1721413656.365:161): proctitle=2F7573722F7362696E2F6874747064002D44464F524547524F554E44
type=SYSCALL msg=audit(1721413656.365:161): arch=c000003e syscall=49 success=no exit=-13 a0=4 a1=557ed0e8c438 a2=1c a3=7ffc8c05e0fc items=0 ppid=1 pid=1582 auid=4294967295 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=(none) ses=4294967295 comm="httpd" exe="/usr/sbin/httpd" subj=system_u:system_r:httpd_t:s0 key=(null)
type=AVC msg=audit(1721413656.365:161): avc:  denied  { name_bind } for  pid=1582 comm="httpd" src=30000 scontext=system_u:system_r:httpd_t:s0 tcontext=system_u:object_r:unreserved_port_t:s0 tclass=tcp_socket permissive=0</code></pre>
</div>
</div>
<div class="paragraph">
<p>You might expect a second AVC on the new document root, but the Apache Web Server terminated with an error code before it tried to open any web page. We will get there shortly.</p>
</div>
<div class="paragraph">
<p>In the previous AVC error, notice the following fields, starting from the end of the message and going backwards:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The resource class (<code>t_class</code>) of <code>tcp_socket</code></p>
</li>
<li>
<p>The resource context (<code>tcontext</code>) of type <code>unreserved_port_t</code></p>
</li>
<li>
<p>The domain context (<code>scontext</code>) of type <code>httpd_t</code></p>
</li>
<li>
<p>The resource name (<code>src</code>) which matches the port number <code>30000</code></p>
</li>
<li>
<p>The message (<code>msg</code>) which includes the string "denied"</p>
</li>
<li>
<p>The audit event type (<code>type</code>) of <code>AVC</code></p>
</li>
<li>
<p>The executable file (<code>exec</code>) of <code>/usr/sbin/httpd</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Get an explanation for the AVC error.</p>
<div class="paragraph">
<p>3.1. In a real scenario, there could be multiple AVC denials from different processes, and you would triage and save them into different files to process in small groups, or one-by-one. Because we have only one AVC error, we can pipe the output of <code>ausearch</code> directly into <code>audit2why</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo ausearch -m AVC -ts recent | audit2why</strong>
type=AVC msg=audit(1721413656.365:161): avc:  denied  { name_bind } for  pid=1582 comm="httpd" src=30000 scontext=system_u:system_r:httpd_t:s0 tcontext=system_u:object_r:unreserved_port_t:s0 tclass=tcp_socket permissive=0

        Was caused by:
        The boolean nis_enabled was set incorrectly.
        Description:
        Allow nis to enabled

        Allow access by executing:
        # setsebool -P nis_enabled 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that <code>audit2why</code> suggests an INCORRECT way of fixing the AVC, so do NOT follow its advice. You know your static web site has no need of enabling Network Information Systems (NIS), which is nowadays considered a very outdated technology.</p>
</div>
<div class="paragraph">
<p>3.2. If you took too long to review the AVC error, the previous step might return "&lt;no matches&gt;". In this case, you can filter by the application binary, which is also useful when there are AVC erros from multiple processes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo ausearch -m AVC -x /usr/sbin/httpd | audit2why</strong>
... same output as previous step ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>3.3. To illustrate how the suggestion from <code>audit2why</code> could look more sane, here&#8217;s the output you would get if, instead of 30000, you configure your Apache Web Serve to listen on port 8000:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">type=AVC msg=audit(1721416004.455:243): avc:  denied  { name_bind } for  pid=5343 comm="httpd" src=8000 scontext=system_u:system_r:httpd_t:s0 tcontext=system_u:object_r:soundd_port_t:s0 tclass=tcp_socket permissive=0

        Was caused by:
                Missing type enforcement (TE) allow rule.

                You can use audit2allow to generate a loadable module to allow this access.</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, <code>audit2why</code> suggests creating a custom policy module to fix the AVC. Sometimes this can be the right approach, but in this particular case the loaded policy already assigns TCP port 8000 to a different resource type (<code>soundd_port_t</code>). It would be better to avoid interfering with the default policies from RHEL, but if you have to, you could add allow rules so the Apache Web Server has access to more resource types.</p>
</div>
<div class="paragraph">
<p>Feel free to change your Apache Web Server configuration and retry the previous steps to see this differeent suggestion by yourself. Or if you prefer, just proceed to the next step.</p>
</div>
</li>
<li>
<p>Assess if the suggestion from <code>audit2why</code> was a good one.</p>
<div class="paragraph">
<p>4.1. We already know that our Apache Web Server configuration does not require NIS, and that the previous recommendation looks odd. But let&#8217;s check what enabling that boolean entais:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo sesearch -A -s httpd_t -b nis_enabled</strong>
...
allow nsswitch_domain reserved_port_type:tcp_socket name_connect; [ nis_enabled ]:True
...
allow nsswitch_domain unreserved_port_t:tcp_socket name_connect; [ nis_enabled ]:True
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is a long list of allow rules, which raises a red flag. After all, we want network servers to run under the most restrictive policy we can.</p>
</div>
<div class="paragraph">
<p>4.2. Check the range of ports that would be allowed by the boolean.
It includes a resouce types which grant a large range of TCP ports:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>semanage port -l | grep tcp | grep 'unreserved_port_t'</strong>
unreserved_port_t              tcp      61000-65535, 1024-3276</code></pre>
</div>
</div>
<div class="paragraph">
<p>That made <code>audit2why</code> suggest the boolean. We do not want our web server vulnerable to exploits which would listen to more network ports.</p>
</div>
<div class="paragraph">
<p>By the way, the fact that NIS requires such a large range of network ports is among the reasons the technology is not considered secure nowadays. The targeted policy from RHEL includes many booleans to support legacy technologies and those booleans are disabled by default and you should be careful to not enable them unless there&#8217;s a real need.</p>
</div>
</li>
<li>
<p>Because we didn&#8217;t like the suggestion from <code>audit2why</code>, check if the <code>sealert</code> provides a better suggesiton.</p>
<div class="paragraph">
<p>5.1. Save the AVC errors into a text file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo ausearch -m AVC -x /usr/sbin/httpd &gt; avc.log</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>5.2. Install the <code>sealert</code> tool, if it&#8217;s not available on your test machine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>dnf -y install setroubleshoot-server</strong>
Complete!</code></pre>
</div>
</div>
<div class="paragraph">
<p>5.3. Process the text file with <code>sealert</code>. It gives a long output, with multiple suggestions. Let&#8217;s revew them one by one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sealert -a avc.log</strong>
found 1 alerts in avc.log
--------------------------------------------------------------------------------

SELinux is preventing /usr/sbin/httpd from name_bind access on the tcp_socket port 30000.
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>5.4. The first suggestion is to change the resource type for port 30000. It seems a good one, but the Apache Web Server can listen to multiple port types and we need some guidance on which one, if we decide to follow this suggestion:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
*****  Plugin bind_ports (92.2 confidence) suggests   ************************

If you want to allow /usr/sbin/httpd to bind to network port 30000
Then you need to modify the port type.
Do
# semanage port -a -t PORT_TYPE -p tcp 30000
    where PORT_TYPE is one of the following: http_cache_port_t, http_port_t, jboss_management_port_t, jboss_messaging_port_t, ntop_port_t, puppet_port_t.
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>5.5. The second suggestion is enabling the same boolean we got from <code>audit2why</code>, which we do not consider a good suggesiton:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
*****  Plugin catchall_boolean (7.83 confidence) suggests   ******************

If you want to allow nis to enabled
Then you must tell SELinux about this by enabling the 'nis_enabled' boolean.
You can read 'httpd_selinux' man page for more details.
Do
setsebool -P nis_enabled 1
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>5.6. The third and latest suggestion is creating a custom policy module, and this is something we wish to avoid, if we can:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
*****  Plugin catchall (1.41 confidence) suggests   **************************

If you believe that httpd should be allowed name_bind access on the port 30000 tcp_socket by default.
Then you should report this as a bug.
You can generate a local policy module to allow this access.
Do
allow this access for now by executing:
# ausearch -c 'httpd' --raw | audit2allow -M my-httpd
# semodule -X 300 -i my-httpd.pp
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can ignore the remaining of the output of <code>sealert</code>, which provides contextual information about the system where it runs and the AVC errors it processed.</p>
</div>
</li>
<li>
<p>Review the online policy docs for a proper fix.</p>
<div class="paragraph">
<p>The first suggestion from <code>sealert</code>, of changing the resource type of TCP port 30000, seems to be the best one. It is the more restrictive one, but it lists a number of candidate port types that the Apache Web Server confined domain has access to and we must pick one.</p>
</div>
<div class="paragraph">
<p>You could use the <code>seinfo</code>, <code>sesearch</code>, and <code>semanage</code> commands, which we already explored in previous labs, to introspect the loaded SELinux policy and figure the resource type for listening to HTTP connections. Instead of guessing, let&#8217;s review the policy documentation for the purpose of each of the port types.</p>
</div>
<div class="paragraph">
<p>6.1. Install the <code>selinux-policy-docs</code> package and review the man pages for the Apache Web Server policy module.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>dnf -y install selinux-policy docs</strong>
...
Complete!
$ <strong>man httpd_selinux</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>Browse the man page and see it includes a somewhat long list of booleans from the policy, which is followed by a list of port types. Skip the list of managed files which just state resource domains the domain has access to, and see the list of file contexts. Most of the times, the information you need is in either the lists of ports types or the list of file contexts.</p>
</div>
<div class="paragraph">
<p>6.2. From the man page, the follwing resource type seems to be the one we need:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
       http_port_t

       Default Defined Ports:
                 tcp 80,81,443,488,8008,8009,8443,9000
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>6.4. Check that your system sets only the default ports to the <code>http_port_t</code> type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo semanage port -l | grep http_port_t</strong>
http_port_t                    tcp      80, 81, 443, 488, 8008, 8009, 8443, 9000
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>6.5. Try to label the 30000 TCP port with the correct SELinux context. It is expected to fail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo semanage port -a -t http_port_t -p tcp 30000</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>6.6. And verify the new port was added to the policy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo semanage port -l | grep http_port_t</strong>
http_port_t                    tcp      30000, 80, 81, 443, 488, 8008, 8009, 8443, 9000
...</code></pre>
</div>
</div>
</li>
<li>
<p>Try again starting the Apache Web Server and check if there are more AVC errors.</p>
<div class="paragraph">
<p>7.1. Start Apache Web and verify it sucessfully listen for connections on the new port:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>systemctl start httpd</strong>
$ <strong>systemctl is-active httpd</strong>
active
$ <strong>ss -ltnp | grep 30000</strong>
LISTEN 0      511                <strong>:30000            *:</strong>    users:(("httpd",pid=5682,fd=4),("httpd",pid=5681,fd=4),("httpd",pid=5680,fd=4),("httpd",pid=5678,fd=4))</code></pre>
</div>
</div>
<div class="paragraph">
<p>7.2. Do not celebrate yet, a running web server may still not be able to serve HTML pages. Try accessing the web site on localhost:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl http://127.0.0.1:30000/index.html</strong>
&lt;!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN"&gt;
&lt;html&gt;&lt;head&gt;
&lt;title&gt;403 Forbidden&lt;/title&gt;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>7.3. You are sure the <code>httpd</code> daemon should have access to the <code>/var/website/index.html</code> file, right?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">ls -l /var/website/index.html
-rw-r--r--. 1 root root 26 Jul 19 14:22 /var/website/index.html</code></pre>
</div>
</div>
<div class="paragraph">
<p>7.4. Verify if there are new AVC errors. You shold see "denied" entry which refers to a <code>path</code> of <code>/var/website/index.html</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">ausearch -m AVC -ts recent
----
time-&gt;Fri Jul 19 16:26:33 2024
type=PROCTITLE msg=audit(1721420793.896:460): proctitle=2F7573722F7362696E2F6874747064002D44464F524547524F554E44
type=SYSCALL msg=audit(1721420793.896:460): arch=c000003e syscall=262 success=no exit=-13 a0=ffffff9c a1=7f1bc8004af8 a2=7f1bddffa8b0 a3=0 items=0 ppid=5678 pid=5682 auid=4294967295 uid=48 gid=48 euid=48 suid=48 fsuid=48 egid=48 sgid=48 fsgid=48 tty=(none) ses=4294967295 comm="httpd" exe="/usr/sbin/httpd" subj=system_u:system_r:httpd_t:s0 key=(null)
type=AVC msg=audit(1721420793.896:460): avc:  denied  { getattr } for  pid=5682 comm="httpd" path="/var/website/index.html" dev="vda4" ino=26341349 scontext=system_u:system_r:httpd_t:s0 tcontext=unconfined_u:object_r:var_t:s0 tclass=file permissive=0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because <code>httpd</code> runs in a confined domain, it is expected that it has no access to most resource types, such as <code>var_t</code> from our web page, which is the default context set by the loaded policy for all files under the <code>/var</code> directory.</p>
</div>
<div class="paragraph">
<p>7.5. Check the advice, if any, from <code>audit2why</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ausearch -m AVC -ts recent | audit2why</strong>
type=AVC msg=audit(1721420793.896:460): avc:  denied  { getattr } for  pid=5682 comm="httpd" path="/var/website/index.html" dev="vda4" ino=26341349 scontext=system_u:system_r:httpd_t:s0 tcontext=unconfined_u:object_r:var_t:s0 tclass=file permissive=0

        Was caused by:
                Missing type enforcement (TE) allow rule.

                You can use audit2allow to generate a loadable module to allow this access.</code></pre>
</div>
</div>
<div class="paragraph">
<p>It suggests generating a policy module, which would allow the <code>httpd_t</code> domain type access to the <code>var_t</code> resource type. It is a best practice to avoiding adding to the policy, in order to keep a minimal attack surface. Fortunately, there is a better fix for this case.</p>
</div>
<div class="paragraph">
<p>7.6. Check the advice from <code>sealert</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ausearch -m AVC -ts recent &gt; avc2.log</strong>
$ <strong>sealert -a avc2.log</strong>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first suggestion looks like a good one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">*****  Plugin restorecon (94.8 confidence) suggests   ************************

If you want to fix the label.
/var/website/index.html default label should be httpd_sys_content_t.
Then you can run restorecon. The access attempt may have been stopped due to insufficient permissions to access a parent directory in which case try to change the following command accordingly.
Do
# /sbin/restorecon -v /var/website/index.html
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The other suggestion from <code>sealert</code> provides a long list of file types the Apache Web Server domains has access to.</p>
</div>
</li>
<li>
<p>Change the context type of the alternate document root.</p>
<div class="paragraph">
<p>8.1. Review the <code>httpd_selinux(8)</code> man page to confirm the proper resource type for web pages. Or copy it from the default document root:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ls -dZ /var/www/html/</strong>
system_u:object_r:httpd_sys_content_t:s0 /var/www/html/</code></pre>
</div>
</div>
<div class="paragraph">
<p>8.2. Add the <code>/var/website</code> directory tree to the resource type for web pages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>semanage fcontext -a -t httpd_sys_content_t "/var/website(/.</strong>)?"*
$ <strong>restorecon -Rv /var/website</strong>
Relabeled /var/website from unconfined_u:object_r:var_t:s0 to unconfined_u:object_r:httpd_sys_content_t:s0
Relabeled /var/website/index.html from unconfined_u:object_r:var_t:s0 to unconfined_u:object_r:httpd_sys_content_t:s0</code></pre>
</div>
</div>
</li>
<li>
<p>Restart the Apache Web Server and check that now you can access the static web site.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo systemctl restart httpd</strong>
$ <strong>curl http://127.0.0.1:30000/index.html</strong>
&lt;h1&gt;Minimal Web Site&lt;/h1&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_next_steps"><a class="anchor" href="#_next_steps"></a>Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Interpreting AVC errors require careful consideration of what the offending application is trying to do and knowledge of the targeted policy set from RHEL.</p>
</div>
<div class="paragraph">
<p>Before we start activities related to creating a custom SELinux policy, let&#8217;s discuss how to ensure multiple servers and desktops have consistent SELinux settings.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_from_here_on_raw_copy_and_paste_from_other_sources_pending_reorganization"><a class="anchor" href="#_from_here_on_raw_copy_and_paste_from_other_sources_pending_reorganization"></a>FROM HERE ON, RAW COPY-AND-PASTE FROM OTHER SOURCES, PENDING REORGANIZATION</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://docs.google.com/presentation/d/11K6ykCk2d9QySZ3rVzJWnX6FADEGLCacVAmumbBlENs/edit#" class="bare">https://docs.google.com/presentation/d/11K6ykCk2d9QySZ3rVzJWnX6FADEGLCacVAmumbBlENs/edit#</a></p>
</div>
<div class="sect2">
<h3 id="_custom_httpd_config_slides_105_122"><a class="anchor" href="#_custom_httpd_config_slides_105_122"></a>Custom httpd config: slides #105-122</h3>
<div class="paragraph">
<p>TROUBLESHOOTING EXISTING POLICY</p>
</div>
<div class="paragraph">
<p>MISLABELED SYSTEM I.E LABELS ON OBJECTS ARE WRONG</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># restorecon -Rv /</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># fixfiles onboot
# reboot</code></pre>
</div>
</div>
<div class="paragraph">
<p>SELINUX MODIFICATIONS OF THE DISTRO POLICY VIA SELINUX USERSPACE TOOLING</p>
</div>
<div class="paragraph">
<p>SOMETIMES IT’S NOT NECESSARY TO CREATE CUSTOM SELINUX POLICY, LOCAL MODIFICATION CAN FIX IT.</p>
</div>
<div class="paragraph">
<p>APACHE HTTP SERVER WITH CHANGES IN THE DEFAULT CONFIGURATION</p>
</div>
<div class="paragraph">
<p>httpd service configured to listen on tcp port 3131 instead of port 80
document root will be /var/test_www/ instead of /var/www/</p>
</div>
<div class="paragraph">
<p>Change in /etc/httpd/conf/httpd.conf</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># sed -i 's_Listen 80_Listen 3131_' /etc/httpd/conf/httpd.conf
# sed -i 's_DocumentRoot "/var/www/html"<em>DocumentRoot "/var/test\_www/html"</em>' /etc/httpd/conf/httpd.conf
# sed -i 's_&lt;Directory "/var/www/html"&gt;_&lt;Directory "/var/test_www/html"&gt;_' /etc/httpd/conf/httpd.conf</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">APPLY CHANGES IN THE CONFIGURATION AND SEARCH FOR AVC DENIALS

# systemctl restart httpd
# ausearch -m AVC -ts recent</code></pre>
</div>
</div>
<div class="paragraph">
<p>httpd service trying to bind on port 3131 instead of 80, this should be changed in SELinux policy</p>
</div>
<div class="paragraph">
<p>type=AVC msg=audit(1491948261.488:599): avc:  denied  { name_bind } for  pid=5920 comm="httpd" src=3131 scontext=system_u:system_r:httpd_t:s0 tcontext=system_u:object_r:unreserved_port_t:s0 tclass=tcp_socket</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># semanage port -l | grep 80
http_port_t                	tcp  	80, 81, 443, 488, 8008,   8009, 8443, 9000

# sesearch -A -s httpd_t -t http_port_t  -c tcp_socket  -p name_bind
Found 1 semantic av rules:
  allow httpd_t http_port_t : tcp_socket name_bind ;

# semanage port -a -t http_port_t -p tcp 3131
# semanage port -l | grep http_port_t
http_port_t                	tcp  	3131, 80, 81, 443, 488, 8008,   8009, 8443, 9000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># systemctl restart httpd
# wget localhost:3131/index.html</code></pre>
</div>
</div>
<div class="paragraph">
<p>httpd service DocumentRoot is in /var/test_www/html and this directory has wrong label</p>
</div>
<div class="paragraph">
<p>type=AVC msg=audit(1491949594.146:622): avc:  denied  { read } for  pid=6094 comm="httpd" name="index.html" dev="dm-0" ino=13485999 scontext=system_u:system_r:httpd_t:s0 tcontext=unconfined_u:object_r:var_t:s0 tclass=file</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># matchpathcon /var/test_www/html/index.html
/var/test_www/html/index.html    system_u:object_r:var_t:s0

# matchpathcon /var/www/html/index.html
/var/www/html/index.html    system_u:object_r:httpd_sys_content_t:s0

# semanage fcontext -a -t httpd_sys_content_t "/var/test_www(/.*)?"
# restorecon -Rv /var/</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># semanage fcontext -l | grep httpd_sys_content_t | grep www
var/www(/.<strong>)?            all files
system_u:object_r:httpd_sys_content_t:s0
/var/test_www(/.</strong>)?    all files
system_u:object_r:httpd_sys_content_t:s0
....
....</code></pre>
</div>
</div>
<div class="paragraph">
<p>HTTPD SERVICE SELINUX DENIALS ARE FIXED WITHOUT WRITING CUSTOM POLICY!</p>
</div>
</div>
<div class="sect2">
<h3 id="_skip_local_policies_using_cil"><a class="anchor" href="#_skip_local_policies_using_cil"></a>Skip: Local policies using CIL</h3>

</div>
<div class="sect2">
<h3 id="_skip_packaging_policies_as_rpms"><a class="anchor" href="#_skip_packaging_policies_as_rpms"></a>Skip: Packaging policies as RPMs</h3>

</div>
<div class="sect2">
<h3 id="_skip_ansible_collections"><a class="anchor" href="#_skip_ansible_collections"></a>Skip: Ansible collections</h3>

</div>
<div class="sect2">
<h3 id="_skip_selinux_news"><a class="anchor" href="#_skip_selinux_news"></a>Skip: SELinux News</h3>

</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="s3-avc.html">Interpreting AVC messages</a></span>
  <span class="next"><a href="s5-multihost.html">Consistent SElinux settings</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
